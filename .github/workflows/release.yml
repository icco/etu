name: Release
on:
  schedule:
    # Run daily at midnight UTC
    - cron: 0 0 * * *
  workflow_dispatch: # Allows manual triggering
permissions:
  contents: write
  packages: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history for semantic versioning
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
      - name: Determine next version
        id: versioning
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: v
          major_pattern: 'BREAKING CHANGE:'
          minor_pattern: 'feat:'
          version_format: ${major}.${minor}.${patch}
      - name: Set version for tag push
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          tag_name="${GITHUB_REF#refs/tags/}"
          echo "version_tag=$tag_name" >> $GITHUB_OUTPUT
          echo "version=$tag_name" >> $GITHUB_OUTPUT
      - name: Create and push tag
        if: github.event_name != 'push' && steps.versioning.outputs.version_tag != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.versioning.outputs.version_tag }}
          git push origin ${{ steps.versioning.outputs.version_tag }}
      - name: Run GoReleaser
        if: steps.versioning.outputs.version_tag != '' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ~> v2
          args: release --clean
        env:
          # Use GITHUB_TOKEN for releases in the same repo
          # For homebrew tap, use a PAT if available, otherwise fall back to GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
